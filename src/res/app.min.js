'use strict';let tg=window.Telegram.WebApp;tg.expand();let uid=0,lang="",nn="";"object"===typeof tg.initDataUnsafe.user&&(uid=tg.initDataUnsafe.user.id,lang=tg.initDataUnsafe.user.language_code,nn=tg.initDataUnsafe.user.first_name.substring(0,1),nn+=tg.initDataUnsafe.user.last_name.substring(0,1),0===nn.length&&(nn=tg.initDataUnsafe.user.username.substring(0,1)));const loader=document.createElement("img");loader.style="display:block;opacity: 0.5;border-radius: 16px;";loader.src="img/loader.gif";
const userpic=document.createElement("img");userpic.style="display:block";userpic.src="photo.php?uid="+uid+"&nn="+nn;addEventListener("DOMContentLoaded",a=>{page("default")});let current_page=null,buscfg=null,day_names=null,pass=null,upd_interval=null;
function page(a,b=null){null!==b&&(b.onclick=null,b.classList.add("disabled"));clearInterval(upd_interval);current_page=a;b="";var c=a.indexOf("&");0<=c&&(current_page=a.substring(0,c),b=a.substring(c));(a=document.getElementById("driver_pin"))&&(b+="&pin="+a.value);get_data("page_"+current_page+".php?uid="+uid+"&lang="+lang+b,function(d){document.body.innerHTML=d;var e=d.indexOf("\x3c!--# "),g=d.indexOf(" #--\x3e");0<=e&&0<=g&&(d=JSON.parse(d.substring(e+6,g)),"object"===typeof d.buscfg&&(buscfg=
d.buscfg),"object"===typeof d.pass&&(pass=d.pass),"object"===typeof d.day_names&&(day_names=d.day_names),"object"===typeof d.times&&d.times.forEach(f=>{timeadd(f)}),"object"===typeof d.run&&d.run.forEach(function(f){switch(f){case "drawseats":drawseats();break;case "seatscfg":seatscfg();break;case "draw_pass":draw_pass()}}));upd_interval=setInterval(function(){get_data("pass.php",function(f){f=JSON.parse(f);"object"===typeof f.pass&&(pass=f.pass,draw_pass())})},1E4)})}
function drawseats(){if("object"===typeof buscfg){var a=document.getElementById("bus");if(null!==a){a.innerHTML="";for(let c=0;c<buscfg.height;c++){if(0<c){var b=document.createElement("div");b.classList.add("divider");a.appendChild(b)}for(b=0;b<buscfg.width;b++){let d=c+":"+b,e=document.createElement("div");e.id=d;e.classList.add("seat");buscfg.driver===d&&e.classList.add("driver");buscfg.exclude.includes(d)&&e.classList.add("exclude");e.onclick=function(){stoggle(e)};a.appendChild(e)}}}}}
function btn_del_click(a){a.classList.contains("yes")?a.classList.remove("yes"):a.classList.add("yes")}function get_data(a,b,c=null){fetch(a,{method:null===c?"GET":"POST",body:null===c?null:JSON.stringify(c),headers:{"Content-type":"application/json; charset=UTF-8"}}).then(d=>d.text()).then(d=>{b(d)})}function sidl(){return"0:0"}function sidr(){return"0:"+(buscfg.width-1)}var btnl,btnr,seath,seatw;
function seatscfg(){var a=document.getElementById("bus_name");a.value=buscfg.bus_name;a.readOnly=""!==buscfg.bus_name;var b=document.getElementById("seatcfg");if(null!==b){a=document.createElement("div");a.classList.add("seatcfg");b.appendChild(a);btnl=document.createElement("div");btnl.classList.add("cfgitem");btnl.classList.add("drvl");buscfg.driver===sidl()&&btnl.classList.add("selected");btnr=document.createElement("div");btnr.classList.add("cfgitem");btnr.classList.add("drvr");buscfg.driver===
sidr()&&btnr.classList.add("selected");btnl.onclick=function(){btnr.classList.remove("selected");btnl.classList.add("selected");drawbus()};btnr.onclick=function(){btnl.classList.remove("selected");btnr.classList.add("selected");drawbus()};a.appendChild(btnl);a.appendChild(btnr);a=document.createElement("div");a.classList.add("seatcfg");b.appendChild(a);var c=document.createElement("div");c.classList.add("cfgitem");c.classList.add("ver");a.appendChild(c);c=document.createElement("div");c.classList.add("cfgitem");
c.classList.add("btnm");c.onclick=function(){buscfg.height--;1>buscfg.height&&(buscfg.height=1);drawbus()};a.appendChild(c);seath=document.createElement("div");seath.classList.add("cfgval");seath.innerHTML=buscfg.height;a.appendChild(seath);c=document.createElement("div");c.classList.add("cfgitem");c.classList.add("btnp");c.onclick=function(){buscfg.height++;20<buscfg.height&&(buscfg.height=20);drawbus()};a.appendChild(c);c=document.createElement("div");c.classList.add("cfgitem");c.classList.add("hor");
a.appendChild(c);c=document.createElement("div");c.classList.add("cfgitem");c.classList.add("btnm");c.onclick=function(){buscfg.width--;1>buscfg.width&&(buscfg.width=1);drawbus()};a.appendChild(c);seatw=document.createElement("div");seatw.classList.add("cfgval");seatw.innerHTML=buscfg.width;a.appendChild(seatw);c=document.createElement("div");c.classList.add("cfgitem");c.classList.add("btnp");c.onclick=function(){buscfg.width++;5<buscfg.width&&(buscfg.width=5);drawbus()};a.appendChild(c);a=document.createElement("div");
a.classList.add("seatcfg");b.appendChild(a);b=document.createElement("div");b.id="btn_save";b.classList.add("cfgitem");b.classList.add("save");b.onclick=function(){savebus()};a.appendChild(b);var d=document.createElement("div");d.id="btn_del";d.classList.add("cfgitem");d.classList.add("del");d.onclick=function(){btn_del_click(d)};a.appendChild(d)}}
function driverseat(){seatw.innerHTML=buscfg.width;seath.innerHTML=buscfg.height;btnl.classList.contains("selected")&&(buscfg.driver=sidl());btnr.classList.contains("selected")&&(buscfg.driver=sidr());let a=buscfg.exclude.indexOf(buscfg.driver);0<=a&&buscfg.exclude.splice(a,1)}function excludechk(){buscfg.exclude.forEach(function(a,b){a=a.split(":");(parseInt(a[0])>=buscfg.height||parseInt(a[1])>=buscfg.width)&&buscfg.exclude.splice(b,1)})}
function drawbus(){excludechk();driverseat();drawseats()}function savebus(){var a=document.getElementById("bus_name");buscfg.bus_name=a.value;var b=document.getElementById("btn_save");b.classList.add("disabled");var c=document.getElementById("btn_del");buscfg.delete=c.classList.contains("yes");get_data("bus.php",function(d){b.classList.remove("disabled");"ok"===d&&document.getElementById("btn0").click();a.classList.remove("error");"bus_name"===d&&a.classList.add("error")},buscfg)}
function saveroute(){var a={route_name:document.getElementById("route_name").value,bus_name:document.getElementById("bus_name").value,times:[],delete:document.getElementById("btn_del").classList.contains("yes")},b=!1;document.getElementById("times").childNodes.forEach(d=>{if("timeitem"===d.id){var e=d.querySelector("input");e.classList.remove("error");""===e.value&&(e.classList.add("error"),b=!0);a.times.push({day:parseInt(d.querySelector("select").value),time:e.value})}});if(!b){var c=document.getElementById("btn_save");
c.classList.add("disabled");get_data("route.php",function(d){c.classList.remove("disabled");"ok"===d&&document.getElementById("btn0").click();var e=document.getElementById("bus_name");e.classList.remove("error");"bus_name"===d&&e.classList.add("error");e=document.getElementById("route_name");e.classList.remove("error");"route_name"===d&&e.classList.add("error");e=document.getElementById("timeadd");"times"===d&&e.classList.add("error")},a)}}
function timeadd(a=null){null===a&&document.getElementById("timeadd").classList.remove("error");var b=document.createElement("div");b.className="timeitem";b.id="timeitem";var c=document.createElement("select"),d=0;day_names.forEach(f=>{var h=document.createElement("option");h.value=d++;h.innerHTML=f;c.appendChild(h)});null!==a&&(c.getElementsByTagName("option")[a.day].selected="selected");b.appendChild(c);var e=document.createElement("input");e.setAttribute("type","time");null!==a&&(e.value=a.time);
b.appendChild(e);a=document.createElement("div");a.className="cfgitem rem";b.appendChild(a);var g=document.getElementById("timeadd");g.parentNode.insertBefore(b,g);a.onclick=function(){g.parentNode.removeChild(b)}}function img(a,b){a.innerHTML="";a.appendChild(loader.cloneNode());var c=new Image;c.onload=function(){a.innerHTML="";a.appendChild(c)};c.style="display: block";c.src="photo.php?uid="+b}
function draw_pass(){for(let a=0;a<buscfg.height;a++)for(let b=0;b<buscfg.width;b++)document.getElementById(a+":"+b).innerHTML="";pass.forEach(function(a){img(document.getElementById(a.seat),a.uid)})}function stoggle(a){switch(current_page){case "bus":bus_stoggle(a);break;case "book":book_stoggle(a)}}
function bus_stoggle(a){if(buscfg.driver!==a.id){var b=buscfg.exclude.indexOf(a.id);0>b?(a.classList.add("exclude"),buscfg.exclude.push(a.id)):(a.classList.remove("exclude"),buscfg.exclude.splice(b,1))}}
function book_stoggle(a){if(!(buscfg.driver===a.id||0<=buscfg.exclude.indexOf(a.id))){var b=document.getElementById("book_label");b.innerHTML=STR_PROCESS;var c=a.onclick;a.onclick=null;a.innerHTML="";a.appendChild(loader.cloneNode());get_data("book.php",function(d){a.innerHTML="";"accept"===d&&a.appendChild(userpic.cloneNode());b.innerHTML=STR_DONE;d.startsWith("busy")&&(img(a,parseInt(d.substring(5))),b.innerHTML=STR_BUSY);a.onclick=c},{sid:a.id})}};
